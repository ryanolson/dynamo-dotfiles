{{- if and (hasKey . "onepassword") .onepassword.enabled }}
# Secrets loaded from 1Password, cached as fish universal variables
# Run `refresh-secrets` to manually reload
{{- if .onepassword.service_account_token }}

# 1Password service account token (loaded from file for security)
# Token file is created by chezmoi apply with 600 permissions
set -l __op_token_file $HOME/.config/op/token
if test -f $__op_token_file
    set -gx OP_SERVICE_ACCOUNT_TOKEN (cat $__op_token_file)
end
{{- end }}

if status is-interactive
    function refresh-secrets --description "Reload secrets from 1Password"
        if not command -v op >/dev/null 2>&1
            echo "1Password CLI (op) not installed"
            return 1
        end
        if not op whoami >/dev/null 2>&1
            echo "Not authenticated to 1Password. Run: op signin (or set OP_SERVICE_ACCOUNT_TOKEN)"
            return 1
        end
        {{ range $key, $ref := .onepassword.secrets -}}
        set -l val (op read "{{ $ref }}" 2>/dev/null)
        and set -Ux {{ $key | upper }} $val
        {{ end -}}
        mkdir -p $HOME/.cache
        date +%s > $HOME/.cache/dynamo-secrets-ts
        echo "Secrets refreshed from 1Password"
    end

    # Auto-refresh if cache is stale (>3600s) and op is available
    set -l __needs_refresh true
    if test -f $HOME/.cache/dynamo-secrets-ts
        set -l __ts (cat $HOME/.cache/dynamo-secrets-ts)
        set -l __now (date +%s)
        if test (math $__now - $__ts) -lt 3600
            set __needs_refresh false
        end
    end

    if test "$__needs_refresh" = true
        if command -v op >/dev/null 2>&1; and op whoami >/dev/null 2>&1
            refresh-secrets >/dev/null 2>&1
        end
    end
end
{{- else }}
# 1Password integration disabled. Enable in ~/.config/chezmoi/chezmoi.yaml:
#   data:
#     onepassword:
#       enabled: true
{{- end }}
