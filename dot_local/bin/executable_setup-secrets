#!/bin/bash
# Setup and verify 1Password secrets integration for Dynamo dotfiles
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}  OK${NC}  $1"; }
warn() { echo -e "${YELLOW}WARN${NC}  $1"; }
fail() { echo -e "${RED}FAIL${NC}  $1"; }

echo ""
echo "Dynamo Secrets Setup"
echo "===================="
echo ""

# 1. Check op CLI is installed
log "Checking 1Password CLI..."
if command -v op &> /dev/null; then
    success "op CLI installed ($(op --version))"
else
    fail "1Password CLI (op) not installed"
    echo "  Install: brew install 1password-cli (macOS)"
    echo "  Or run:  chezmoi apply  (installs automatically)"
    exit 1
fi

# 2. Check op is signed in
log "Checking 1Password sign-in..."
if op account list &> /dev/null; then
    success "Signed in to 1Password"
else
    fail "Not signed in to 1Password"
    echo "  Run: op account add   (first time)"
    echo "  Run: op signin        (subsequent times)"
    exit 1
fi

# 3. Verify expected vault items exist
log "Checking vault items..."
VAULT="Development"
ITEMS=("Anthropic API" "HuggingFace" "GitHub Token")
ALL_FOUND=true

for item in "${ITEMS[@]}"; do
    if op item get "$item" --vault "$VAULT" &> /dev/null; then
        success "Found '$item' in vault '$VAULT'"
    else
        fail "Missing '$item' in vault '$VAULT'"
        ALL_FOUND=false
    fi
done

if [ "$ALL_FOUND" = false ]; then
    echo ""
    warn "Some vault items are missing. Create them in 1Password:"
    echo "  Vault: $VAULT"
    echo "  Items needed: ${ITEMS[*]}"
    echo "  Each item should have a 'credential' field with the API key/token"
fi

# 4. Verify commit signing configuration
log "Checking commit signing configuration..."

SIGNING_KEY="$(git config --global user.signingkey 2>/dev/null || true)"
if [ -n "$SIGNING_KEY" ]; then
    success "user.signingkey is set"
else
    warn "user.signingkey is not set — commit signing is disabled"
    echo "  Run: chezmoi init  (and provide your SSH public key when prompted)"
fi

if [ -f "$HOME/.ssh/allowed_signers" ]; then
    success "~/.ssh/allowed_signers exists"
else
    warn "~/.ssh/allowed_signers is missing — signature verification won't work"
    echo "  Run: chezmoi apply"
fi

if [[ "$OSTYPE" == darwin* ]]; then
    if [ -x "/Applications/1Password.app/Contents/MacOS/op-ssh-sign" ]; then
        success "op-ssh-sign found (macOS)"
    else
        warn "op-ssh-sign not found — install 1Password desktop app"
    fi
else
    if [ -n "${SSH_AUTH_SOCK:-}" ]; then
        success "SSH_AUTH_SOCK is set (Linux agent forwarding)"
    else
        warn "SSH_AUTH_SOCK is not set — connect with ssh -A for signing"
    fi

    GPG_SSH_PROG="$(git config --global gpg.ssh.program 2>/dev/null || true)"
    if [ -z "$GPG_SSH_PROG" ]; then
        success "gpg.ssh.program is unset (will use ssh-keygen — correct for Linux)"
    else
        warn "gpg.ssh.program is set to '$GPG_SSH_PROG' — should be unset on Linux"
    fi
fi

if [ -n "$SIGNING_KEY" ]; then
    log "Testing commit signature..."
    TMPDIR="$(mktemp -d)"
    if (cd "$TMPDIR" && git init -q && git commit --allow-empty -m "signing test" -q 2>/dev/null); then
        success "Test commit signed successfully"
    else
        warn "Test commit signing failed — check 1Password agent connection"
    fi
    rm -rf "$TMPDIR"
fi

echo ""
log "To upload your signing key to GitHub (for Verified badges):"
echo "  gh ssh-key add ~/.ssh/allowed_signers --type signing --title 'chezmoi-signing'"
echo "  Or: GitHub.com > Settings > SSH and GPG keys > New SSH key > Type: Signing Key"

# 5. Print next steps
echo ""
echo "Next Steps"
echo "----------"
echo ""
echo "1. Enable 1Password in chezmoi config:"
echo "   Create/edit ~/.config/chezmoi/chezmoi.yaml:"
echo ""
echo "   data:"
echo "     name: \"Your Name\""
echo "     email: \"your.email@company.com\""
echo "     onepassword:"
echo "       enabled: true"
echo "       ssh_agent: true"
echo ""
echo "2. Apply configuration:"
echo "   chezmoi apply"
echo ""
echo "3. Restart your shell, then verify:"
echo "   echo \$ANTHROPIC_API_KEY"
echo "   ssh -T git@github.com"
echo ""
echo "4. Manual auth steps (one-time per machine):"
echo "   claude login          # Claude Code OAuth (opens browser)"
echo "   gh auth login -p ssh  # GitHub CLI via SSH agent"
echo ""
